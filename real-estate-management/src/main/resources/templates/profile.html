<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <a href="/" class="btn btn-outline-secondary btn-sm mb-3">‚Üê Back Home</a>
        <h1 class="mb-4">Your Profile & Status</h1>
        
        <div class="card shadow-lg">
            <div class="card-header bg-info text-white">Account Information</div>
            <div class="card-body">
                <div id="profileDetails">
                    <p class="text-warning">Loading user data...</p>
                </div>
            </div>
            <div class="card-footer d-flex justify-content-between">
                <button onclick="logout()" class="btn btn-danger">Logout</button>
                <a href="/register" class="btn btn-warning">Edit Profile (Coming Soon)</a>
            </div>
        </div>
    </div>

    <script>
        const credentials = localStorage.getItem('user_credentials');
        const profileDetailsDiv = document.getElementById('profileDetails');

        if (!credentials) {
            window.location.href = '/login'; // Redirect if not logged in
        }

        function logout() {
            localStorage.removeItem('user_credentials');
            window.location.href = '/login';
        }

        function loadProfileData() {
            fetch('http://localhost:8080/api/users/me', {
                method: 'GET',
                headers: {
                    'Authorization': 'Basic ' + credentials
                }
            })
            .then(response => {
                if (response.status === 401 || response.status === 403) {
                    profileDetailsDiv.innerHTML = '<p class="text-danger">Session expired or unauthorized. Please log in again.</p>';
                    return Promise.reject('Auth Failed');
                }
                return response.json();
            })
            .then(user => {
                let userRole = 'User';
                let badgeClass = 'bg-secondary';
                
                if (user.sellerType) { userRole = 'Seller'; badgeClass = 'bg-warning'; }
                else if (user.budget && user.preferredLocation) { userRole = 'Buyer'; badgeClass = 'bg-success'; }
                else if (user.leaseTerm) { userRole = 'Tenant'; badgeClass = 'bg-info'; }
                else if (user.adminPrivileges) { userRole = 'Admin'; badgeClass = 'bg-danger'; }


                profileDetailsDiv.innerHTML = `
                    <p><strong>Name:</strong> ${user.firstName} ${user.lastName}</p>
                    <p><strong>Email:</strong> ${user.email}</p>
                    <p><strong>Mobile:</strong> ${user.mobile}</p>
                    <p><strong>Role:</strong> <span class="badge ${badgeClass} fs-6">${userRole}</span></p>
                    <hr>
                    <p class="small text-muted">Account created on: ${user.createdOn}</p>
                `;
            })
            .catch(error => {
                console.error('Error fetching profile:', error);
                if (error !== 'Auth Failed') {
                    profileDetailsDiv.innerHTML = '<p class="text-danger">Failed to connect to the profile service.</p>';
                }
            });
        }

        loadProfileData();
    </script>
</body>
</html>