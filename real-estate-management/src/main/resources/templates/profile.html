<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <a href="/" class="btn btn-outline-secondary btn-sm mb-3">← Back Home</a>
        <h1 class="mb-4">Your Profile & Status</h1>
        
        <div class="card shadow-lg mb-4">
            <div class="card-header bg-info text-white">Account Information</div>
            <div class="card-body">
                <div id="profileDetails">
                    <p class="text-warning">Loading user data...</p>
                </div>
            </div>
            <div class="card-footer d-flex justify-content-between">
                <div>
                    <button onclick="logout()" class="btn btn-danger">Logout</button>
                </div>
                <div>
                    <a href="/edit-profile" class="btn btn-warning me-2">Edit Profile</a>
                    <button onclick="deleteProfile()" class="btn btn-outline-danger">Delete Profile</button>
                    </div>
            </div>
        </div>

        <div class="card shadow-lg">
            <div class="card-header" id="dynamicHeader">My Data</div>
            <div class="card-body">
                <div id="dynamicContent">
                    <p class="text-muted">Loading specific data based on your role...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- FIX: REMOVED all 'credentials' and 'localStorage' variables ---
        const profileDetailsDiv = document.getElementById('profileDetails');
        const dynamicHeader = document.getElementById('dynamicHeader');
        const dynamicContent = document.getElementById('dynamicContent');

        function logout() {
            // This function POSTs to the /logout endpoint
            fetch('/logout', { method: 'POST' })
                .then(() => {
                    window.location.href = '/login'; // Redirect to login
                })
                .catch(err => {
                    console.error('Logout error:', err);
                    window.location.href = '/login'; // Redirect anyway
                });
        }
        function deleteProperty(id) {
            const confirmed = confirm("Are you sure you want to delete this property? This is permanent.");
            if (!confirmed) {
                return;
            }

            fetch(`/api/properties/my-properties/${id}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    alert('Property deleted successfully.');
                    // Reload all data to refresh the list
                    loadProfileData();
                } else if (response.status === 403) {
                    alert('Error: You do not have permission to delete this.');
                } else {
                    alert('Error: Could not delete property.');
                }
            })
            .catch(err => {
                console.error('Delete property error:', err);
                alert('A network error occurred.');
            });
        }
        function deleteProfile() {
            const confirmed = confirm("Are you sure you want to delete your profile? This action is permanent and cannot be undone.");
            
            if (confirmed) {
                fetch('/api/users/me', {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        alert('Profile deleted successfully. You will now be logged out.');
                        // Call logout to clear the session
                        logout();
                    } else {
                        alert('Error: Could not delete profile.');
                    }
                })
                .catch(err => {
                    console.error('Delete error:', err);
                    alert('A network error occurred.');
                });
            }
        }

        function loadProfileData() {
            // --- FIX: No 'credentials' needed. The cookie is sent automatically. ---
            fetch('http://localhost:8080/api/users/me')
                .then(response => {
                    if (!response.ok) {
                        // If not OK, the session is invalid or expired.
                        throw new Error('Auth Failed');
                    }
                    return response.json();
                })
                .then(user => {
                    let userRole = 'User';
                    let badgeClass = 'bg-secondary';
                    let roleKey = null; 
                    let adminLink = '';

                    // This logic for determining role is correct
                    if (user.sellerType) { 
                        userRole = 'Seller'; 
                        badgeClass = 'bg-success'; 
                        roleKey = 'seller';
                    } else if (user.preferredLocation) { 
                        userRole = 'Buyer'; 
                        badgeClass = 'bg-info'; 
                        roleKey = 'buyer';
                    } else if (user.leaseTerm) { 
                        userRole = 'Tenant'; 
                        badgeClass = 'bg-primary'; 
                        roleKey = 'tenant';
                    } else if (user.adminPrivileges) { 
                        userRole = 'Admin'; 
                        badgeClass = 'bg-danger'; 
                        roleKey = 'admin';
                        adminLink = '<a href="/admin" class="btn btn-danger">Go to Admin Panel</a>';
                    }

                    profileDetailsDiv.innerHTML = `
                        <p><strong>Name:</strong> ${user.firstName} ${user.lastName}</p>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Mobile:</strong> ${user.mobile}</p>
                        <p><strong>Role:</strong> <span class="badge ${badgeClass} fs-6">${userRole}</span></p>
                        ${adminLink} <hr>
                        <p class="small text-muted">Account created on: ${user.createdOn}</p>
                    `;

                    loadDynamicData(roleKey);
                })
                .catch(error => {
                    console.error('Error fetching profile:', error);
                    if (error.message === 'Auth Failed') {
                        // If auth fails, redirect to login
                        window.location.href = '/login';
                    } else {
                        profileDetailsDiv.innerHTML = '<p class="text-danger">Failed to connect to the profile service.</p>';
                    }
                });
        }

        /**
         * Fetches and renders role-specific data (e.g., seller's properties)
         */
        function loadDynamicData(roleKey) {
            let endpoint = '';
            let header = '';
            let renderFunc = null;

            switch(roleKey) {
                case 'seller':
                    endpoint = 'http://localhost:8080/api/sellers/my-properties';
                    header = 'My Listed Properties';
                    renderFunc = (data) => `
                        <ul class="list-group">
                            ${data.map(prop => `
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <a href="/details?id=${prop.propertyId}">${prop.city} - ${prop.address}</a>
                                        <span class="badge bg-primary ms-2">${prop.propertyStatus}</span>
                                    </div>
                                    <div>
                                        <a href="/edit-property?id=${prop.propertyId}" class="btn btn-sm btn-outline-warning me-2">Update</a>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProperty(${prop.propertyId})">Delete</button>
                                    </div>
                                </li>`).join('')}
                        </ul>
                    `;
                    break;
                case 'buyer':
                    endpoint = 'http://localhost:8080/api/buyers/my-purchases';
                    header = 'My Purchase History';
                    renderFunc = (data) => `
                        <ul class="list-group">
                            ${data.map(buy => `
                                <li class="list-group-item">
                                    Purchased Property ID: <a href="/details?id=${buy.property.propertyId}">${buy.property.propertyId}</a> 
                                    on ${buy.buyingDate} for ₹${buy.amount}
                                </li>`).join('')}
                        </ul>
                    `;
                    break;
                case 'tenant':
                    endpoint = 'http://localhost:8080/api/tenants/my-leases';
                    header = 'My Lease History';
                    renderFunc = (data) => `
                        <ul class="list-group">
                            ${data.map(lease => `
                                <li class="list-group-item">
                                    Leased Property ID: <a href="/details?id=${lease.property.propertyId}">${lease.property.propertyId}</a> 
                                    from ${lease.startDate} to ${lease.endDate}
                                </li>`).join('')}
                        </ul>
                    `;
                    break;
                default:
                    dynamicHeader.textContent = 'No Data';
                    dynamicContent.innerHTML = '<p class="text-muted">No specific data to show for this role.</p>';
                    return;
            }

            dynamicHeader.textContent = header;
            dynamicContent.innerHTML = '<p>Loading...</p>';

            // --- FIX: This fetch no longer needs to send 'credentials' ---
            fetch(endpoint) // The browser will send the cookie automatically
                .then(res => res.json())
                .then(data => {
                    if (data.length === 0) {
                        dynamicContent.innerHTML = `<p class="text-muted">No data found.</p>`;
                        return;
                    }
                    dynamicContent.innerHTML = renderFunc(data);
                })
                .catch(err => {
                    console.error('Error fetching dynamic data:', err);
                    dynamicContent.innerHTML = '<p class="text-danger">Failed to load data.</p>';
                });
        }

        // --- This is the only call needed to start the page ---
        loadProfileData();
    </script>
</body>
</html>