<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <a href="/" class="btn btn-outline-secondary btn-sm mb-3">← Back Home</a>
        <h1 class="mb-4 text-danger">Admin Dashboard</h1>
        
        <div id="adminCheck"></div>

        <div id="adminContent" style="display: none;">
            <div class="card shadow-lg mb-4">
                <div class="card-header bg-danger text-white">Property Management</div>
                <div class="card-body">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Type</th>
                                <th>Location</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="propertyList">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="card shadow-lg">
                <div class="card-header bg-dark text-white">User Management</div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                            </tr>
                        </thead>
                        <tbody id="userList">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const credentials = localStorage.getItem('user_credentials');
        const adminCheckDiv = document.getElementById('adminCheck');
        const adminContentDiv = document.getElementById('adminContent');

        if (!credentials) {
            window.location.href = '/login'; // Redirect if not logged in
        }

        // 1. Verify user is an ADMIN first
        fetch('http://localhost:8080/api/users/me', {
            headers: { 'Authorization': 'Basic ' + credentials }
        })
        .then(res => {
            if (!res.ok) return Promise.reject('Auth failed');
            return res.json();
        })
        .then(user => {
            // Check for the 'adminPrivileges' field
            if (user.adminPrivileges) {
                adminCheckDiv.innerHTML = '<p class="alert alert-success">Admin role verified. Loading data...</p>';
                adminContentDiv.style.display = 'block';
                // 2. Load admin data
                loadAllProperties();
                loadAllUsers();
            } else {
                adminCheckDiv.innerHTML = '<p class="alert alert-danger">Access Denied. You are not an Admin.</p>';
            }
        })
        .catch(() => {
            adminCheckDiv.innerHTML = '<p class="alert alert-danger">Session expired. Please <a href="/login">log in</a>.</p>';
        });

        // 3. Load All Properties
        function loadAllProperties() {
            const propertyList = document.getElementById('propertyList');
            fetch('http://localhost:8080/api/properties/all', {
                headers: { 'Authorization': 'Basic ' + credentials }
            })
            .then(res => res.json())
            .then(properties => {
                propertyList.innerHTML = properties.map(prop => `
                    <tr id="prop-row-${prop.propertyId}">
                        <td>${prop.propertyId}</td>
                        <td>${prop.propertyType}</td>
                        <td>${prop.city}, ${prop.state}</td>
                        <td>₹${prop.price.toLocaleString('en-IN')}</td>
                        <td>${prop.propertyStatus}</td>
                        <td>
                            <button class_name="btn btn-danger btn-sm" onclick="deleteProperty(${prop.propertyId})">
                                Delete
                            </button>
                        </td>
                    </tr>
                `).join('');
            });
        }

        // 4. Load All Users
        function loadAllUsers() {
            const userList = document.getElementById('userList');
            fetch('http://localhost:8080/api/users/all', {
                headers: { 'Authorization': 'Basic ' + credentials }
            })
            .then(res => res.json())
            .then(users => {
                userList.innerHTML = users.map(user => {
                    let role = 'User';
                    if (user.sellerType) role = 'Seller';
                    else if (user.preferredLocation) role = 'Buyer';
                    else if (user.leaseTerm) role = 'Tenant';
                    else if (user.adminPrivileges) role = 'Admin';
                    
                    return `
                        <tr>
                            <td>${user.userId}</td>
                            <td>${user.firstName} ${user.lastName}</td>
                            <td>${user.email}</td>
                            <td>${role}</td>
                        </tr>
                    `;
                }).join('');
            });
        }

        // 5. Delete Property Function
        function deleteProperty(id) {
            if (!confirm(`Are you sure you want to delete Property ID #${id}? This action cannot be undone.`)) {
                return;
            }

            fetch(`http://localhost:8080/api/properties/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Basic ' + credentials }
            })
            .then(response => {
                if (response.ok) {
                    alert('Property deleted successfully.');
                    // Remove the row from the table
                    document.getElementById(`prop-row-${id}`).remove();
                } else {
                    alert('Delete failed. You may not have permission.');
                }
            })
            .catch(err => {
                console.error('Delete error:', err);
                alert('An error occurred.');
            });
        }
    </script>
</body>
</html>