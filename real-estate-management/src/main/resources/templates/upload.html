<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Upload New Property</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .property-fields {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <a href="/" class="btn btn-outline-secondary btn-sm mb-3">‚Üê Back Home</a>
        <h1 class="mb-4">List New Property (Seller Access Required)</h1>
        
        <div class="card shadow-lg">
            <div class="card-header bg-warning text-dark">Enter Property Details</div>
            <div class="card-body">
                <div id="authCheck"></div>

                <form id="uploadForm" style="display: none;">
                    
                    <div class="mb-3">
                        <label for="propertyType" class="form-label">1. Select Property Type</label>
                        <select id="propertyType" class="form-select" required>
                            <option value="" disabled selected>-- Select a Type --</option>
                            <option value="flats">Flat</option>
                            <option value="lands">Land</option>
                            <option value="commercials">Commercial</option>
                            <option value="rentals">Rental</option>
                            <option value="colivings">Coliving</option>
                        </select>
                    </div>

                    <div id="commonFields" class="mt-4" style="display: none;">
                        <h5 class="border-bottom pb-2">2. Common Details</h5>
                        <div class="row g-3">
                            <div class="col-md-6"><label class="form-label">Price / Rent (per month)</label><input type="number" id="price" class="form-control" placeholder="Price" required></div>
                            <div class="col-md-6"><label class="form-label">Address</label><input type="text" id="address" class="form-control" placeholder="Address" required></div>
                            <div class="col-md-6"><label class="form-label">City</label><input type="text" id="city" class="form-control" placeholder="City" required></div>
                            <div class="col-md-6"><label class="form-label">State</label><input type="text" id="state" class="form-control" placeholder="State" required></div>
                            <div class="col-md-6"><label class="form-label">PIN</label><input type="number" id="pin" class="form-control" placeholder="PIN" required></div>
                            <div class="col-12"><label class="form-label">Description</label><textarea id="description" class="form-control" placeholder="Description..."></textarea></div>
                        </div>
                    </div>

                    <div id="dynamicFields" class="mt-4" style="display: none;">
                        <h5 class="border-bottom pb-2">3. Specific Details</h5>

                        <div id="flatsFields" class="property-fields row g-3">
                            <div class="col-md-4"><label class="form-label">BHK</label><input type="number" id="flatBhk" class="form-control" placeholder="BHK"></div>
                            <div class="col-md-4"><label class="form-label">Bathrooms</label><input type="number" id="flatBathrooms" class="form-control" placeholder="# of Bathrooms"></div>
                            <div class="col-md-4"><label class="form-label">Floor Number</label><input type="number" id="flatFloorNumber" class="form-control" placeholder="Floor Number"></div>
                            <div class="col-md-4"><label class="form-label">Built Area (sq ft)</label><input type="number" id="flatBuiltArea" class="form-control" placeholder="Built Area"></div>
                            <div class="col-md-4"><label class="form-label">Carpet Area (sq ft)</label><input type="number" id="flatCarpetArea" class="form-control" placeholder="Carpet Area"></div>
                            <div class="col-md-4"><label class="form-label">Maintenance (monthly)</label><input type="number" id="flatMaintenance" class="form-control" placeholder="Maintenance Charge"></div>
                            <div class="col-md-4"><label class="form-label">Furnishing</label><select id="flatFurnishing" class="form-select"><option value="Unfurnished">Unfurnished</option><option value="Semi-Furnished">Semi-Furnished</option><option value="Furnished">Furnished</option></select></div>
                            <div class="col-md-4"><label class="form-label">Parking</label><select id="flatParking" class="form-select"><option value="true">Yes</option><option value="false">No</option></select></div>
                            <div class="col-md-4"><label class="form-label">Lift</label><select id="flatHasLift" class="form-select"><option value="true">Yes</option><option value="false">No</option></select></div>
                        </div>

                        <div id="landsFields" class="property-fields row g-3">
                            <div class="col-md-6"><label class="form-label">Land Area (sq ft)</label><input type="number" id="landArea" class="form-control" placeholder="Land Area"></div>
                            <div class="col-md-6"><label class="form-label">Zoning Type</label><input type="text" id="landZoning" class="form-control" placeholder="Zoning Type (e.g., Residential)"></div>
                            <div class="col-md-6"><label class="form-label">Fenced</label><select id="landHasFence" class="form-select"><option value="true">Yes</option><option value="false">No</option></select></div>
                            <div class="col-md-6"><label class="form-label">Road Access</label><select id="landHasRoad" class="form-select"><option value="true">Yes</option><option value="false">No</option></select></div>
                        </div>

                        <div id="commercialsFields" class="property-fields row g-3">
                            <div class="col-md-4"><label class="form-label">Commercial Type</label><input type="text" id="comType" class="form-control" placeholder="e.g., Office, Shop"></div>
                            <div class="col-md-4"><label class="form-label">Built Area (sq ft)</label><input type="number" id="comBuiltArea" class="form-control" placeholder="Built Area"></div>
                            <div class="col-md-4"><label class="form-label">Carpet Area (sq ft)</label><input type="number" id="comCarpetArea" class="form-control" placeholder="Carpet Area"></div>
                            <div class="col-md-4"><label class="form-label">Washrooms</label><input type="number" id="comWashrooms" class="form-control" placeholder="# of Washrooms"></div>
                            <div class="col-md-4"><label class="form-label">Floor Number</label><input type="number" id="comFloorNumber" class="form-control" placeholder="Floor Number"></div>
                            <div class="col-md-4"><label class="form-label">Parking</label><select id="comParking" class="form-select"><option value="true">Yes</option><option value="false">No</option></select></div>
                        </div>
                        
                        <div id="rentalsFields" class="property-fields row g-3">
                            <div class="col-md-4"><label class="form-label">Deposit Amount</label><input type="number" id="rentDeposit" class="form-control" placeholder="Deposit Amount"></div>
                            <div class="col-md-4"><label class="form-label">Lease Term (months)</label><input type="number" id="rentLeaseTerm" class="form-control" placeholder="Lease Term (months)"></div>
                            <div class="col-md-4"><label class="form-label">Preferred Tenant</label><input type="text" id="rentTenantType" class="form-control" placeholder="e.g., Family, Bachelors"></div>
                            <div class="col-md-4"><label class="form-label">Furnishing</label><select id="rentFurnishing" class="form-select"><option value="Unfurnished">Unfurnished</option><option value="Semi-Furnished">Semi-Furnished</option><option value="Furnished">Furnished</option></select></div>
                            <div class="col-md-4"><label class="form-label">Pets Allowed</label><select id="rentPetAllowed" class="form-select"><option value="true">Yes</option><option value="false">No</option></select></div>
                            <div class="col-md-4"><label class="form-label">Available From</label><input type="date" id="rentAvailableFrom" class="form-control"></div>
                        </div>

                        <div id="colivingsFields" class="property-fields row g-3">
                            <div class="col-md-4"><label class="form-label">Rent per Person</label><input type="number" id="colRentPerPerson" class="form-control" placeholder="Rent per Person"></div>
                            <div class="col-md-4"><label class="form-label">Room Type</label><input type="text" id="colRoomType" class="form-control" placeholder="e.g., Private, Shared"></div>
                            <div class="col-md-4"><label class="form-label">Gender Preference</label><input type="text" id="colGenderPref" class="form-control" placeholder="e.g., Female, Co-ed"></div>
                            <div class="col-md-4"><label class="form-label">Total Rooms</label><input type="number" id="colTotalRooms" class="form-control" placeholder="Total Rooms"></div>
                            <div class="col-md-4"><label class="form-label">Available Rooms</label><input type="number" id="colAvailableRooms" class="form-control" placeholder="Available Rooms"></div>
                            <div class="col-md-4"><label class="form-label">Cleaning Service</label><select id="colCleaning" class="form-select"><option value="true">Yes</option><option value="false">No</option></select></div>
                        </div>
                    </div>

                    <div id="amenitiesFields" class="mt-4" style="display: none;">
                        </div>
                    
                    <button type="submit" class="btn btn-success btn-lg mt-4 w-100" style="display: none;">LIST PROPERTY NOW</button>
                    <p id="statusMessage" class="mt-3 text-center"></p>
                </form>
            </div>
        </div>
    </div>

    <script>
        const authCheckDiv = document.getElementById('authCheck');
        const uploadForm = document.getElementById('uploadForm');
        const statusMessage = document.getElementById('statusMessage');
        const propertyTypeSelect = document.getElementById('propertyType');
        const commonFieldsDiv = document.getElementById('commonFields');
        const dynamicFieldsDiv = document.getElementById('dynamicFields');
        const amenitiesFieldsDiv = document.getElementById('amenitiesFields'); 
        const submitButton = document.querySelector('button[type="submit"]');

        // (Auth check remains the same)
        fetch('http://localhost:8080/api/users/me')
            .then(res => {
                if (!res.ok) { window.location.href = '/login'; return Promise.reject('Auth failed'); }
                return res.json();
            })
            .then(user => {
                if (user.sellerType) {
                    authCheckDiv.innerHTML = '<p class="alert alert-success">Authentication successful. You are logged in as a Seller.</p>';
                    uploadForm.style.display = 'block';
                } else {
                    authCheckDiv.innerHTML = '<p class="alert alert-danger">Authorization Failed: You must be a <strong>Seller</strong> to list properties.</p>';
                }
            })
            .catch(err => {
                if (err !== 'Auth failed') { authCheckDiv.innerHTML = '<p class="alert alert-danger">Session invalid. Please <a href="/login">log in</a>.</p>'; }
            });
        
        // --- NEW HELPER FUNCTION ---
        // This function dynamically sets the 'required' attribute on inputs
        function updateRequiredFields(selectedSectionId) {
            // Loop over ALL .property-fields sections
            document.querySelectorAll('.property-fields').forEach(section => {
                // Find all inputs within this section
                const inputs = section.querySelectorAll('input, select');
                
                if (section.id === selectedSectionId) {
                    // This is the section we WANT to show. Make its fields required.
                    inputs.forEach(input => {
                        // Check if the field was marked as required in the HTML
                        // (We re-use the original 'required' attribute from your HTML)
                        if (input.hasAttribute('data-was-required')) {
                            input.required = true;
                        }
                    });
                } else {
                    // This is a HIDDEN section. Make its fields NOT required.
                    inputs.forEach(input => {
                        // Before removing 'required', store a marker
                        if (input.required) {
                            input.setAttribute('data-was-required', 'true');
                        }
                        input.required = false;
                    });
                }
            });
        }
        
        // --- MODIFIED Dropdown Listener ---
        propertyTypeSelect.addEventListener('change', function() {
            const selectedType = this.value; // e.g., "flats"
            const sectionIdToShow = selectedType ? selectedType + 'Fields' : null; // e.g., "flatsFields"

            // 1. Hide all dynamic sections
            document.querySelectorAll('.property-fields').forEach(div => {
                div.style.display = 'none';
            });
            
            // 2. Update the 'required' attributes based on selection
            updateRequiredFields(sectionIdToShow);

            if (selectedType) {
                // 3. Show the correct section
                const sectionToShow = document.getElementById(sectionIdToShow);
                if (sectionToShow) { sectionToShow.style.display = 'flex'; }
                
                // 4. Show common fields and button
                commonFieldsDiv.style.display = 'block';
                dynamicFieldsDiv.style.display = 'block';
                amenitiesFieldsDiv.style.display = 'block'; 
                submitButton.style.display = 'block';
            } else {
                // Hide all if no type is selected
                commonFieldsDiv.style.display = 'none';
                dynamicFieldsDiv.style.display = 'none';
                amenitiesFieldsDiv.style.display = 'none'; 
                submitButton.style.display = 'none';
            }
        });

        // --- MODIFIED Submit Listener ---
        uploadForm.addEventListener('submit', function(event) {
            event.preventDefault(); 

            // This check will now ONLY validate visible required fields
            if (!uploadForm.checkValidity()) {
                uploadForm.reportValidity();
                return; 
            }

            const propertyType = propertyTypeSelect.value;
            const endpoint = `http://localhost:8080/api/${propertyType}`;

            // --- PAYLOAD LOGIC ---
            // (We will add checks for empty strings and convert to null or 0)
            
            // 1. Get Base Payload
            const basePayload = {
                "listedDate": new Date().toISOString().split('T')[0],
                "price": parseFloat(document.getElementById('price').value),
                "propertyStatus": "FOR_SALE", 
                "address": document.getElementById('address').value,
                "city": document.getElementById('city').value,
                "state": document.getElementById('state').value, 
                "pin": parseInt(document.getElementById('pin').value),
                "description": document.getElementById('description').value || null
            };

            // 2. Get Specific Payload
            let specificPayload = {};
            switch(propertyType) {
                case 'flats':
                    specificPayload = {
                        "bhk": parseInt(document.getElementById('flatBhk').value),
                        "bathrooms": parseInt(document.getElementById('flatBathrooms').value),
                        "floorNumber": parseInt(document.getElementById('flatFloorNumber').value) || 0,
                        "builtArea": parseInt(document.getElementById('flatBuiltArea').value),
                        "carpetArea": parseInt(document.getElementById('flatCarpetArea').value),
                        "maintenanceCharge": parseFloat(document.getElementById('flatMaintenance').value) || 0,
                        "furnishingStatus": document.getElementById('flatFurnishing').value,
                        "parking": document.getElementById('flatParking').value === 'true',
                        "hasLift": document.getElementById('flatHasLift').value === 'true'
                    };
                    break;
                case 'lands':
                    specificPayload = {
                        "landArea": parseInt(document.getElementById('landArea').value),
                        "zoningType": document.getElementById('landZoning').value,
                        "hasFence": document.getElementById('landHasFence').value === 'true',
                        "hasRoad": document.getElementById('landHasRoad').value === 'true'
                    };
                    break;
                case 'commercials':
                    specificPayload = {
                        "commercialType": document.getElementById('comType').value,
                        "builtArea": parseInt(document.getElementById('comBuiltArea').value),
                        "carpetArea": parseInt(document.getElementById('comCarpetArea').value),
                        "washrooms": parseInt(document.getElementById('comWashrooms').value) || 0,
                        "floorNumber": parseInt(document.getElementById('comFloorNumber').value) || 0,
                        "parkingSpace": document.getElementById('comParking').value === 'true'
                    };
                    break;
                case 'rentals':
                    basePayload.propertyStatus = "FOR_RENT"; 
                    specificPayload = {
                        "rent": basePayload.price, 
                        "leaseTerm": parseInt(document.getElementById('rentLeaseTerm').value),
                        "furnishingStatus": document.getElementById('rentFurnishing').value,
                        "petAllowed": document.getElementById('rentPetAllowed').value === 'true',
                        "deposit": parseFloat(document.getElementById('rentDeposit').value) || 0,
                        "availableFrom": document.getElementById('rentAvailableFrom').value || null,
                        "tenantType": document.getElementById('rentTenantType').value || null
                    };
                    break;
                case 'colivings':
                    basePayload.propertyStatus = "FOR_RENT";
                    specificPayload = {
                        "roomType": document.getElementById('colRoomType').value,
                        "genderPreference": document.getElementById('colGenderPref').value,
                        "rentPerPerson": parseFloat(document.getElementById('colRentPerPerson').value),
                        "totalRooms": parseInt(document.getElementById('colTotalRooms').value),
                        "availableRooms": parseInt(document.getElementById('colAvailableRooms').value),
                        "cleaning": document.getElementById('colCleaning').value === 'true'
                    };
                    break;
            }
            
            // 3. Get Amenities
            const amenities = [];
            document.querySelectorAll('.amenity-check:checked').forEach(checkbox => {
                amenities.push({ "amenityName": checkbox.value });
            });

            // 4. Combine payloads
            const finalPayload = { 
                ...basePayload, 
                ...specificPayload,
                "amenities": amenities
            };

            statusMessage.textContent = 'Submitting...';
            statusMessage.className = 'mt-3 text-info';

            // 5. Send to the dynamic endpoint (Fetch logic remains the same)
            fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(finalPayload)
            })
            .then(response => {
                if (response.status === 403) {
                    statusMessage.textContent = 'Upload Failed! Your role is not authorized.';
                    statusMessage.className = 'mt-3 text-danger';
                    return Promise.reject('Forbidden');
                }
                if (!response.ok) {
                    return response.json().then(err => {
                        let msg = err.message || `HTTP Status ${response.status}. Check Server Log.`;
                        statusMessage.textContent = `Upload Failed: ${msg}`;
                        statusMessage.className = 'mt-3 text-danger';
                        return Promise.reject('Error');
                    }).catch(() => {
                        statusMessage.textContent = `Upload Failed: HTTP Status ${response.status}. Check Server Log.`;
                        statusMessage.className = 'mt-3 text-danger';
                        return Promise.reject('Error');
                    });
                }
                return response.json();
            })
            .then(data => {
                statusMessage.textContent = `SUCCESS! ${propertyType} Property ID ${data.propertyId} listed.`;
                statusMessage.className = 'mt-3 text-success';
                uploadForm.reset();
                propertyTypeSelect.dispatchEvent(new Event('change'));
            })
            .catch(error => {
                console.error('Upload Error:', error);
                if (error !== 'Forbidden' && error !== 'Error') {
                    statusMessage.textContent = 'Network error. Please try again.';
                }
            });
        });
        
        // --- ON PAGE LOAD ---
        // We must store the original 'required' state
        document.querySelectorAll('.property-fields input, .property-fields select').forEach(input => {
            if (input.required) {
                input.setAttribute('data-was-required', 'true');
                // Immediately set to false so it doesn't block on load
                input.required = false; 
            }
        });

    </script>
</body>
</html>