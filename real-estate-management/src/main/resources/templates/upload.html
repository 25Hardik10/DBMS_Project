<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Upload New Property</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .property-fields { display: none; }
    </style>
</head>
<body>
<div class="container mt-4">
    <a href="/" class="btn btn-outline-secondary btn-sm mb-3">← Back Home</a>
    <h1 class="mb-4">List New Property (Seller Access Required)</h1>

    <div class="card shadow-lg">
        <div class="card-header bg-warning text-dark">Enter Property Details</div>
        <div class="card-body">
            <div id="authCheck"></div>

            <form id="uploadForm" style="display: none;">
                <div class="mb-3">
                    <label for="propertyType" class="form-label">1. Select Property Type</label>
                    <select id="propertyType" class="form-select" required>
                        <option value="" disabled selected>-- Select a Type --</option>
                        <option value="flats">Flat</option>
                        <option value="lands">Land</option>
                        <option value="commercials">Commercial</option>
                        <option value="rentals">Rental</option>
                        <option value="colivings">Coliving</option>
                    </select>
                </div>

                <div id="commonFields" class="mt-4" style="display: none;">
                    <h5 class="border-bottom pb-2">2. Common Details</h5>
                    <div class="row g-3">
                        <div class="col-md-6"><label class="form-label">Price / Rent (per month)</label><input type="number" id="price" class="form-control" placeholder="Price" required></div>
                        <div class="col-md-6"><label class="form-label">Address</label><input type="text" id="address" class="form-control" placeholder="Address" required></div>
                        <div class="col-md-6"><label class="form-label">City</label><input type="text" id="city" class="form-control" placeholder="City" required></div>
                        <div class="col-md-6"><label class="form-label">State</label><input type="text" id="state" class="form-control" placeholder="State" required></div>
                        <div class="col-md-6"><label class="form-label">PIN</label><input type="number" id="pin" class="form-control" placeholder="PIN" required></div>
                        <div class="col-12"><label class="form-label">Description</label><textarea id="description" class="form-control" placeholder="Description..."></textarea></div>
                        <div class="col-12 mt-3">
                            <label for="imageUrls" class="form-label">Image URLs (comma-separated)</label>
                            <input type="text" id="imageUrls" class="form-control"
                                   placeholder="https://example.com/img1.jpg, https://example.com/img2.jpg">
                            <small class="text-muted">Paste one or more image URLs separated by commas.</small>
                        </div>
                    </div>
                </div>

                <!-- Flat Fields -->
                <div id="flatsFields" class="property-fields row g-3 mt-3">
                    <h5 class="border-bottom pb-2">3. Flat Details</h5>
                    <div class="col-md-4"><label class="form-label">BHK</label><input type="number" id="flatBhk" class="form-control" placeholder="BHK"></div>
                    <div class="col-md-4"><label class="form-label">Bathrooms</label><input type="number" id="flatBathrooms" class="form-control" placeholder="# of Bathrooms"></div>
                    <div class="col-md-4"><label class="form-label">Floor Number</label><input type="number" id="flatFloorNumber" class="form-control" placeholder="Floor Number"></div>
                    <div class="col-md-4"><label class="form-label">Built Area (sq ft)</label><input type="number" id="flatBuiltArea" class="form-control" placeholder="Built Area"></div>
                    <div class="col-md-4"><label class="form-label">Carpet Area (sq ft)</label><input type="number" id="flatCarpetArea" class="form-control" placeholder="Carpet Area"></div>
                    <div class="col-md-4"><label class="form-label">Maintenance</label><input type="number" id="flatMaintenance" class="form-control" placeholder="Maintenance Charge"></div>
                    <div class="col-md-4"><label class="form-label">Furnishing</label><select id="flatFurnishing" class="form-select"><option value="Unfurnished">Unfurnished</option><option value="Semi-Furnished">Semi-Furnished</option><option value="Furnished">Furnished</option></select></div>
                    <div class="col-md-4"><label class="form-label">Parking</label><select id="flatParking" class="form-select"><option value="true">Yes</option><option value="false">No</option></select></div>
                    <div class="col-md-4"><label class="form-label">Lift</label><select id="flatHasLift" class="form-select"><option value="true">Yes</option><option value="false">No</option></select></div>
                </div>

                <button type="submit" class="btn btn-success btn-lg mt-4 w-100" style="display: none;">LIST PROPERTY NOW</button>
                <p id="statusMessage" class="mt-3 text-center"></p>
            </form>
        </div>
    </div>
</div>

<script>
    const uploadForm = document.getElementById('uploadForm');
    const propertyTypeSelect = document.getElementById('propertyType');
    const submitButton = document.querySelector('button[type="submit"]');
    const commonFields = document.getElementById('commonFields');
    const flatFields = document.getElementById('flatsFields');
    const statusMessage = document.getElementById('statusMessage');

    // ✅ Authentication check
    fetch('http://localhost:8080/api/users/me')
        .then(res => res.ok ? res.json() : Promise.reject())
        .then(user => {
            if (user && user.sellerType) {
                uploadForm.style.display = 'block';
            } else {
                alert("You must be logged in as a Seller to upload properties.");
                window.location.href = '/login';
            }
        })
        .catch(() => window.location.href = '/login');

    // ✅ Show proper fields when type selected
    propertyTypeSelect.addEventListener('change', () => {
        const type = propertyTypeSelect.value;
        document.querySelectorAll('.property-fields').forEach(div => div.style.display = 'none');
        if (type === 'flats') flatFields.style.display = 'flex';
        commonFields.style.display = 'block';
        submitButton.style.display = 'block';
    });

    // ✅ Handle form submission
    uploadForm.addEventListener('submit', e => {
        e.preventDefault();

        const propertyType = propertyTypeSelect.value;
        const endpoint = `http://localhost:8080/api/${propertyType}`; // e.g., /api/flats

        const imageUrls = document.getElementById('imageUrls').value
            .split(',')
            .map(u => u.trim())
            .filter(u => u);

        const payload = {
            price: parseFloat(document.getElementById('price').value),
            address: document.getElementById('address').value,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            pin: parseInt(document.getElementById('pin').value),
            description: document.getElementById('description').value,
            propertyStatus: "FOR_SALE",
            listedDate: new Date().toISOString().split('T')[0],
            bhk: parseInt(document.getElementById('flatBhk').value),
            bathrooms: parseInt(document.getElementById('flatBathrooms').value),
            floorNumber: parseInt(document.getElementById('flatFloorNumber').value),
            builtArea: parseInt(document.getElementById('flatBuiltArea').value),
            carpetArea: parseInt(document.getElementById('flatCarpetArea').value),
            maintenanceCharge: parseFloat(document.getElementById('flatMaintenance').value),
            furnishingStatus: document.getElementById('flatFurnishing').value,
            parking: document.getElementById('flatParking').value === 'true',
            hasLift: document.getElementById('flatHasLift').value === 'true',
            imageUrls: imageUrls
        };

        statusMessage.textContent = 'Submitting...';
        statusMessage.className = 'mt-3 text-info';

        fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(res => {
            if (!res.ok) throw new Error('Upload failed');
            return res.json();
        })
        .then(data => {
            statusMessage.textContent = `✅ Property ID ${data.propertyId} uploaded successfully!`;
            statusMessage.className = 'mt-3 text-success';
            uploadForm.reset();
            propertyTypeSelect.selectedIndex = 0;
            document.querySelectorAll('.property-fields').forEach(div => div.style.display = 'none');
            commonFields.style.display = 'none';
            submitButton.style.display = 'none';
        })
        .catch(err => {
            console.error(err);
            statusMessage.textContent = '❌ Upload failed. Check inputs or server.';
            statusMessage.className = 'mt-3 text-danger';
        });
    });
</script>
</body>
</html>
