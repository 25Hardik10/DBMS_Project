<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit Property</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .property-fields { display: none; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <a href="/profile" class="btn btn-outline-secondary btn-sm mb-3">‚Üê Back to Profile</a>
        <h1 class="mb-4" id="pageTitle">Loading Property...</h1>
        
        <div class="card shadow-lg">
            <div class="card-header bg-warning text-dark">Update Property Details</div>
            <div class="card-body">
                <div id="authCheck"></div>

                <form id="editForm" style="display: none;">
                    
                    <div class="mb-3">
                        <label for="propertyType" class="form-label">1. Property Type</label>
                        <select id="propertyType" class="form-select" required disabled>
                            </select>
                    </div>

                    <div id="commonFields" class="mt-4">
                        <h5 class="border-bottom pb-2">2. Common Details</h5>
                        <div class="row g-3">
                            <div class="col-md-6"><label class="form-label">Price / Rent</label><input type="number" id="price" class="form-control" required></div>
                            <div class="col-md-6"><label class="form-label">Address</label><input type="text" id="address" class="form-control" required></div>
                            <div class="col-md-6"><label class="form-label">City</label><input type="text" id="city" class="form-control" required></div>
                            <div class="col-md-6"><label class="form-label">State</label><input type="text" id="state" class="form-control" required></div>
                            <div class="col-md-6"><label class="form-label">PIN</label><input type="number" id="pin" class="form-control" required></div>
                            <div class="col-12"><label class="form-label">Description</label><textarea id="description" class="form-control"></textarea></div>
                        </div>
                    </div>

                    <div id="dynamicFields" class="mt-4">
                        <h5 class="border-bottom pb-2">3. Specific Details</h5>

                        <div id="flatsFields" class="property-fields row g-3">
                            <div class="col-md-4"><label class="form-label">BHK</label><input type="number" id="flatBhk" class="form-control" placeholder="BHK" required></div>
                            <div class="col-md-4"><label class="form-label">Bathrooms</label><input type="number" id="flatBathrooms" class="form-control" placeholder="# of Bathrooms" required></div>
                            <div class="col-md-4"><label class="form-label">Floor Number</label><input type="number" id="flatFloorNumber" class="form-control" placeholder="Floor Number"></div>
                            <div class="col-md-4"><label class="form-label">Built Area (sq ft)</label><input type="number" id="flatBuiltArea" class="form-control" placeholder="Built Area" required></div>
                            <div class="col-md-4"><label class="form-label">Carpet Area (sq ft)</label><input type="number" id="flatCarpetArea" class="form-control" placeholder="Carpet Area" required></div>
                            <div class="col-md-4"><label class="form-label">Maintenance (monthly)</label><input type="number" id="flatMaintenance" class="form-control" placeholder="Maintenance Charge"></div>
                            <div class="col-md-4"><label class="form-label">Furnishing</label><select id="flatFurnishing" class="form-select"><option value="Unfurnished">Unfurnished</option><option value="Semi-Furnished">Semi-Furnished</option><option value="Furnished">Furnished</option></select></div>
                            <div class="col-md-4"><label class="form-label">Parking</label><select id="flatParking" class="form-select"><option value="true">Yes</option><option value="false">No</option></select></div>
                            <div class="col-md-4"><label class="form-label">Lift</label><select id="flatHasLift" class="form-select"><option value="true">Yes</option><option value="false">No</option></select></div>
                        </div>
                        <div id="landsFields" class="property-fields row g-3">
                            <div class="col-md-6"><label class="form-label">Land Area (sq ft)</label><input type="number" id="landArea" class="form-control" placeholder="Land Area" required></div>
                            <div class="col-md-6"><label class="form-label">Zoning Type</label><input type="text" id="landZoning" class="form-control" placeholder="Zoning Type (e.g., Residential)" required></div>
                            <div class="col-md-6"><label class="form-label">Fenced</label><select id="landHasFence" class="form-select"><option value="true">Yes</option><option value="false">No</option></select></div>
                            <div class="col-md-6"><label class="form-label">Road Access</label><select id="landHasRoad" class="form-select"><option value="true">Yes</option><option value="false">No</option></select></div>
                        </div>
                        <div id="commercialsFields" class="property-fields row g-3">
                            <div class="col-md-4"><label class="form-label">Commercial Type</label><input type="text" id="comType" class="form-control" placeholder="e.g., Office, Shop" required></div>
                            <div class="col-md-4"><label class="form-label">Built Area (sq ft)</label><input type="number" id="comBuiltArea" class="form-control" placeholder="Built Area" required></div>
                            <div class="col-md-4"><label class="form-label">Carpet Area (sq ft)</label><input type="number" id="comCarpetArea" class="form-control" placeholder="Carpet Area" required></div>
                            <div class="col-md-4"><label class="form-label">Washrooms</label><input type="number" id="comWashrooms" class="form-control" placeholder="# of Washrooms"></div>
                            <div class="col-md-4"><label class="form-label">Floor Number</label><input type="number" id="comFloorNumber" class="form-control" placeholder="Floor Number"></div>
                            <div class="col-md-4"><label class="form-label">Parking</label><select id="comParking" class="form-select"><option value="true">Yes</option><option value="false">No</option></select></div>
                        </div>
                        <div id="rentalsFields" class="property-fields row g-3">
                            <div class="col-md-4"><label class="form-label">Deposit Amount</label><input type="number" id="rentDeposit" class="form-control" placeholder="Deposit Amount"></div>
                            <div class="col-md-4"><label class="form-label">Lease Term (months)</label><input type="number" id="rentLeaseTerm" class="form-control" placeholder="Lease Term (months)" required></div>
                            <div class="col-md-4"><label class="form-label">Preferred Tenant</label><input type="text" id="rentTenantType" class="form-control" placeholder="e.g., Family, Bachelors"></div>
                            <div class="col-md-4"><label class="form-label">Furnishing</label><select id="rentFurnishing" class="form-select"><option value="Unfurnished">Unfurnished</option><option value="Semi-Furnished">Semi-Furnished</option><option value="Furnished">Furnished</option></select></div>
                            <div class="col-md-4"><label class="form-label">Pets Allowed</label><select id="rentPetAllowed" class="form-select"><option value="true">Yes</option><option value="false">No</option></select></div>
                            <div class="col-md-4"><label class="form-label">Available From</label><input type="date" id="rentAvailableFrom" class="form-control"></div>
                        </div>
                        <div id="colivingsFields" class="property-fields row g-3">
                            <div class="col-md-4"><label class="form-label">Rent per Person</label><input type="number" id="colRentPerPerson" class="form-control" placeholder="Rent per Person" required></div>
                            <div class="col-md-4"><label class="form-label">Room Type</label><input type="text" id="colRoomType" class="form-control" placeholder="e.g., Private, Shared" required></div>
                            <div class="col-md-4"><label class="form-label">Gender Preference</label><input type="text" id="colGenderPref" class="form-control" placeholder="e.g., Female, Co-ed" required></div>
                            <div class="col-md-4"><label class="form-label">Total Rooms</label><input type="number" id="colTotalRooms" class="form-control" placeholder="Total Rooms" required></div>
                            <div class="col-md-4"><label class="form-label">Available Rooms</label><input type="number" id="colAvailableRooms" class="form-control" placeholder="Available Rooms" required></div>
                            <div class="col-md-4"><label class="form-label">Cleaning Service</label><select id="colCleaning" class="form-select"><option value="true">Yes</option><option value="false">No</option></select></div>
                        </div>
                    </div>

                    <div id="amenitiesFields" class="mt-4">
                        <h5 class="border-bottom pb-2">4. Amenities</h5>
                        <div class="row g-3">
                            <div class="col-auto"><input type="checkbox" class="form-check-input amenity-check" value="Gym" id="checkGym"><label class="form-check-label ms-2" for="checkGym">Gym</label></div>
                            <div class="col-auto"><input type="checkbox" class="form-check-input amenity-check" value="Pool" id="checkPool"><label class="form-check-label ms-2" for="checkPool">Pool</label></div>
                            <div class="col-auto"><input type="checkbox" class="form-check-input amenity-check" value="Parking" id="checkParking"><label class="form-check-label ms-2" for="checkParking">Parking</label></div>
                            <div class="col-auto"><input type="checkbox" class="form-check-input amenity-check" value="Lift" id="checkLift"><label class="form-check-label ms-2" for="checkLift">Lift</label></div>
                            <div class="col-auto"><input type="checkbox" class="form-check-input amenity-check" value="Security" id="checkSecurity"><label class="form-check-label ms-2" for="checkSecurity">Security</label></div>
                            <div class="col-auto"><input type="checkbox" class="form-check-input amenity-check" value="Water" id="checkWater"><label class="form-check-label ms-2" for="checkWater">24/7 Water</label></div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-success btn-lg mt-4 w-100">SAVE CHANGES</button>
                    <p id="statusMessage" class="mt-3 text-center"></p>
                </form>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const propertyId = urlParams.get('id');
        let currentProperty = null; 
        let currentUser = null; 
        
        const authCheckDiv = document.getElementById('authCheck');
        const editForm = document.getElementById('editForm');
        const statusMessage = document.getElementById('statusMessage');
        const propertyTypeSelect = document.getElementById('propertyType');
        const pageTitle = document.getElementById('pageTitle');
        
        // --- 1. LOAD ALL DATA ON PAGE LOAD ---
        window.addEventListener('load', function() {
            if (!propertyId) {
                pageTitle.textContent = "Error: No Property ID provided.";
                return;
            }

            const userPromise = fetch('http://localhost:8080/api/users/me')
                .then(res => {
                    if (!res.ok) { window.location.href = '/login'; return Promise.reject('Auth Failed'); }
                    return res.json();
                });

            const propertyPromise = fetch(`http://localhost:8080/api/properties/${propertyId}`)
                .then(res => {
                    if (!res.ok) { return Promise.reject('Property fetch failed'); }
                    return res.json();
                });

            Promise.all([userPromise, propertyPromise])
                // --- FIX: REMOVED THE EXTRA ')' ---
                .then(([user, property]) => {
                    currentUser = user;
                    currentProperty = property;

                    if (user.userId !== property.seller.userId) {
                        authCheckDiv.innerHTML = '<p class="alert alert-danger">Access Denied: You are not the owner of this property.</p>';
                        return Promise.reject('Ownership Mismatch');
                    }

                    authCheckDiv.innerHTML = '<p class="alert alert-success">Authentication successful. Populating data...</p>';
                    editForm.style.display = 'block';
                    populateForm(property);
                })
                .catch(err => {
                    if (err !== 'Auth Failed' && err !== 'Ownership Mismatch') {
                        console.error('Error:', err);
                        statusMessage.textContent = 'Error loading property data.';
                    }
                });
        });

        // --- 2. POPULATE FORM FUNCTION (Corrected) ---
        function populateForm(prop) {
            pageTitle.textContent = `Edit Property #${prop.propertyId}`;

            const typeValue = prop.propertyType.toLowerCase() + 's';
            propertyTypeSelect.innerHTML = `<option value="${typeValue}">${prop.propertyType}</option>`;
            
            // B. Populate Common Fields
            document.getElementById('price').value = prop.price;
            document.getElementById('city').value = prop.city;
            document.getElementById('address').value = prop.address;
            document.getElementById('state').value = prop.state;
            document.getElementById('pin').value = prop.pin;
            document.getElementById('description').value = prop.description;

            // C. Populate Specific Fields
            const sectionToShow = document.getElementById(typeValue + 'Fields');
            if (sectionToShow) {
                sectionToShow.style.display = 'flex';
                
                for (const [key, value] of Object.entries(prop)) {
                    let inputId = null;

                    if (typeValue === 'flats') {
                        inputId = `flat${key.charAt(0).toUpperCase() + key.slice(1)}`;
                    } else if (typeValue === 'lands') {
                        inputId = key; 
                    } else if (typeValue === 'commercials') {
                        if (key === 'parkingSpace') inputId = 'comParking';
                        else if (key === 'commercialType') inputId = 'comType';
                        else inputId = `com${key.charAt(0).toUpperCase() + key.slice(1)}`;
                    } else if (typeValue === 'rentals') {
                        inputId = `rent${key.charAt(0).toUpperCase() + key.slice(1)}`;
                    } else if (typeValue === 'colivings') {
                        inputId = `col${key.charAt(0).toUpperCase() + key.slice(1)}`;
                    }
                    
                    const input = document.getElementById(inputId);
                    if (input) {
                        if (typeof value === 'boolean') {
                            input.value = value.toString();
                        } else if (value !== null) {
                            input.value = value;
                        }
                    }
                }
            }
            
            // D. Populate Amenities
            if (prop. amenities && prop.amenities.length > 0) {
                document.querySelectorAll('.amenity-check').forEach(checkbox => {
                    if (prop.amenities.some(a => a.amenityName === checkbox.value)) {
                        checkbox.checked = true;
                    }
                });
            }
        }
        
        // --- 3. SUBMIT FORM LISTENER (Corrected) ---
        editForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            if (!editForm.checkValidity()) {
                editForm.reportValidity();
                return;
            }
            const propertyType = propertyTypeSelect.value;
            const endpoint = `http://localhost:8080/api/${propertyType}/${propertyId}`;

            // 1. Get Base Payload
            const basePayload = {
                "listedDate": currentProperty.listedDate,
                "price": parseFloat(document.getElementById('price').value),
                "propertyStatus": currentProperty.propertyStatus,
                "address": document.getElementById('address').value,
                "city": document.getElementById('city').value,
                "state": document.getElementById('state').value, 
                "pin": parseInt(document.getElementById('pin').value),
                "description": document.getElementById('description').value || null
            };

            // 2. Get Specific Payload
            let specificPayload = {};
            switch(propertyType) {
                case 'flats':
                    specificPayload = {
                        "bhk": parseInt(document.getElementById('flatBhk').value),
                        "bathrooms": parseInt(document.getElementById('flatBathrooms').value),
                        "floorNumber": parseInt(document.getElementById('flatFloorNumber').value) || 0,
                        "builtArea": parseInt(document.getElementById('flatBuiltArea').value),
                        "carpetArea": parseInt(document.getElementById('flatCarpetArea').value),
                        "maintenanceCharge": parseFloat(document.getElementById('flatMaintenance').value) || 0,
                        "furnishingStatus": document.getElementById('flatFurnishing').value,
                        "parking": document.getElementById('flatParking').value === 'true',
                        "hasLift": document.getElementById('flatHasLift').value === 'true'
                    };
                    break;
                case 'lands':
                    specificPayload = {
                        "landArea": parseInt(document.getElementById('landArea').value),
                        "zoningType": document.getElementById('landZoning').value,
                        "hasFence": document.getElementById('landHasFence').value === 'true',
                        "hasRoad": document.getElementById('landHasRoad').value === 'true'
                    };
                    break;
                case 'commercials':
                    specificPayload = {
                        "commercialType": document.getElementById('comType').value,
                        "builtArea": parseInt(document.getElementById('comBuiltArea').value),
                        "carpetArea": parseInt(document.getElementById('comCarpetArea').value),
                        "washrooms": parseInt(document.getElementById('comWashrooms').value) || 0,
                        "floorNumber": parseInt(document.getElementById('comFloorNumber').value) || 0,
                        "parkingSpace": document.getElementById('comParking').value === 'true'
                    };
                    break;
                case 'rentals':
                    basePayload.propertyStatus = "FOR_RENT"; 
                    specificPayload = {
                        "rent": basePayload.price, 
                        "leaseTerm": parseInt(document.getElementById('rentLeaseTerm').value),
                        "furnishingStatus": document.getElementById('rentFurnishing').value,
                        "petAllowed": document.getElementById('rentPetAllowed').value === 'true',
                        "deposit": parseFloat(document.getElementById('rentDeposit').value) || 0,
                        "availableFrom": document.getElementById('rentAvailableFrom').value || null,
                        "tenantType": document.getElementById('rentTenantType').value || null
                    };
                    break;
                case 'colivings':
                    basePayload.propertyStatus = "FOR_RENT";
                    specificPayload = {
                        "roomType": document.getElementById('colRoomType').value,
                        "genderPreference": document.getElementById('colGenderPref').value,
                        "rentPerPerson": parseFloat(document.getElementById('colRentPerPerson').value),
                        "totalRooms": parseInt(document.getElementById('colTotalRooms').value),
                        "availableRooms": parseInt(document.getElementById('colAvailableRooms').value),
                        "cleaning": document.getElementById('colCleaning').value === 'true'
                    };
                    break;
            }
            
            // 3. Get Amenities
            const amenities = [];
            document.querySelectorAll('.amenity-check:checked').forEach(checkbox => {
                amenities.push({ "amenityName": checkbox.value });
            });

            // 4. Combine payloads
            const finalPayload = { 
                ...basePayload, 
                ...specificPayload,
                "amenities": amenities,
                "seller": currentUser, 
                "propertyId": propertyId 
            };

            statusMessage.textContent = 'Saving...';
            statusMessage.className = 'mt-3 text-info';

            fetch(endpoint, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(finalPayload)
            })
            .then(response => {
                if (response.status === 403) {
                    statusMessage.textContent = 'Update Failed! Not authorized.';
                    statusMessage.className = 'mt-3 text-danger';
                    return Promise.reject('Forbidden');
                }
                if (!response.ok) {
                   return response.json().then(err => {
                        statusMessage.textContent = `Update Failed: ${err.message}`;
                        return Promise.reject('Error');
                   });
                }
                return response.json();
            })
            .then(data => {
                statusMessage.textContent = 'SUCCESS! Property updated. Redirecting...';
                statusMessage.className = 'mt-3 text-success';
                setTimeout(() => {
                    window.location.href = '/profile';
                }, 1500);
            })
            .catch(error => {
                console.error('Update Error:', error);
            });
        });
    </script>
</body>
</html>